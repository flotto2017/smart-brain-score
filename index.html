<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Online Ready)</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #2980b9; --bg-color: #f0f4f8; --card-bg: #ffffff; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .logo { text-align: center; margin-bottom: 20px; font-weight: bold; font-size: 22px; color: #e67e22; }
        .section-title { font-size: 16px; font-weight: bold; margin-top: 15px; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        select, input[type="date"], input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; }
        
        /* Grid ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
        .score-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        @media (max-width: 500px) { .score-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .score-slot { text-align: center; }
        .score-slot input { width: 100%; padding: 8px; text-align: center; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .score-slot span { font-size: 12px; color: #888; }
        
        button { border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.2s; }
        button.save-btn { width: 100%; padding: 12px; background-color: #27ae60; color: white; font-weight: bold; font-size: 18px; margin-top: 20px; }
        button.save-btn:hover { background-color: #219150; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 13px; }
        th { background-color: #f2f2f2; }
        
        .action-btn { padding: 4px 8px; color: white; border-radius: 4px; font-size: 12px; margin: 2px; cursor: pointer; }
        .edit-btn { background-color: #f39c12; }
        .del-btn { background-color: #e74c3c; }
        
        .chart-box { margin-top: 20px; padding: 10px; background: #fafafa; border-radius: 10px; border: 1px solid #eee; position: relative; height: 350px; }
        
        #studentSelect { border: 2px solid var(--primary-color); background-color: #eaf2f8; font-weight: bold; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; font-size: 18px; font-weight: bold; color: var(--primary-color); flex-direction: column; gap: 10px;}
        
        /* Modal Style */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; padding: 20px; border-radius: 10px; width: 85%; max-width: 350px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn-confirm { flex: 1; background: #2980b9; color: white; padding: 10px; font-weight: bold; }
        .btn-cancel { flex: 1; background: #95a5a6; color: white; padding: 10px; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div style="font-size:30px;">‚òÅÔ∏è</div>
    <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<div class="container">
    <div class="logo">‚òÅÔ∏è Smart Brain Score (Online)</div>
    
    <div class="section-title">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
    <div class="input-group">
        <label>üë§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Cloud)</label>
        <select id="studentSelect">
            <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠... --</option>
        </select>
    </div>
    <div class="input-group">
        <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏∂‡∏Å‡∏ã‡πâ‡∏≠‡∏°</label>
        <input type="date" id="practiceDate">
    </div>
    <div style="font-size: 14px; color: #666; margin-bottom:10px;">
        ‡∏£‡∏∞‡∏î‡∏±‡∏ö: <span id="currentLevel" style="font-weight:bold; color:var(--primary-color)">-</span> 
        (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°: <span id="maxScoreDisplay">-</span>)
    </div>

    <div class="section-title">2. ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
    <div class="score-grid">
        <div class="score-slot"><span>‡πÅ‡∏ú‡πà‡∏ô 1</span><input type="number" class="score-input"></div>
        <div class="score-slot"><span>‡πÅ‡∏ú‡πà‡∏ô 2</span><input type="number" class="score-input"></div>
        <div class="score-slot"><span>‡πÅ‡∏ú‡πà‡∏ô 3</span><input type="number" class="score-input"></div>
        <div class="score-slot"><span>‡πÅ‡∏ú‡πà‡∏ô 4</span><input type="number" class="score-input"></div>
        <div class="score-slot"><span>‡πÅ‡∏ú‡πà‡∏ô 5</span><input type="number" class="score-input"></div>
        <div class="score-slot"><span>‡πÅ‡∏ú‡πà‡∏ô 6</span><input type="number" class="score-input"></div>
        <div class="score-slot"><span>‡πÅ‡∏ú‡πà‡∏ô 7</span><input type="number" class="score-input"></div>
        <div class="score-slot"><span>‡πÅ‡∏ú‡πà‡∏ô 8</span><input type="number" class="score-input"></div>
        <div class="score-slot"><span>‡πÅ‡∏ú‡πà‡∏ô 9</span><input type="number" class="score-input"></div>
        <div class="score-slot"><span>‡πÅ‡∏ú‡πà‡∏ô 10</span><input type="number" class="score-input"></div>
    </div>

    <button id="saveBtn" class="save-btn" onclick="saveAllScoresToCloud()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô Cloud</button>

    <div class="chart-box">
        <canvas id="progressChart"></canvas>
    </div>

    <div class="section-title">3. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏ã‡πâ‡∏≠‡∏°</div>
    <div style="overflow-x: auto;">
        <table id="historyTable">
            <thead>
                <tr>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                    <th>‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
<div id="editModal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top:0;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Cloud)</h3>
        <div class="input-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label><input type="date" id="editDateInput"></div>
        <div class="input-group"><label>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label><input type="number" id="editScoreInput"></div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="document.getElementById('editModal').style.display = 'none'">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn-confirm" onclick="saveEditToCloud()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>
</div>

<script>
    // =======================================================
    // üîë ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase
    // =======================================================
    const firebaseConfig = {
      apiKey: "AIzaSyDgs3yQ3CNuH6szyVAJj-IxOk5exJC5Nd8",
      authDomain: "smart-brain-score.firebaseapp.com",
      projectId: "smart-brain-score",
      storageBucket: "smart-brain-score.firebasestorage.app",
      messagingSenderId: "32859759244",
      appId: "1:32859759244:web:446aef63eb76493d0851a9",
      measurementId: "G-X875NZSTYP"
    };

    try {
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
        console.log("Firebase Connected!");
    } catch (e) {
        alert("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
    }

    // =======================================================
    // üü¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Config
    // =======================================================
    const EXAM_CONFIG = {
        '‡∏£‡∏∞‡∏î‡∏±‡∏ö 1Std.': 100, '‡∏£‡∏∞‡∏î‡∏±‡∏ö 1Adv.': 120, '‡∏£‡∏∞‡∏î‡∏±‡∏ö 2': 120, '‡∏£‡∏∞‡∏î‡∏±‡∏ö 3': 120,
        '‡∏£‡∏∞‡∏î‡∏±‡∏ö 4': 160, '‡∏£‡∏∞‡∏î‡∏±‡∏ö 5': 160, '‡∏£‡∏∞‡∏î‡∏±‡∏ö 6': 160, '‡∏£‡∏∞‡∏î‡∏±‡∏ö Open': 100, '‡∏£‡∏∞‡∏î‡∏±‡∏ö Std.': 100
    };

    const TARGET_SCORES = {
        '‡∏£‡∏∞‡∏î‡∏±‡∏ö 1Std.': { rank1: 90, rank5: 65 }, '‡∏£‡∏∞‡∏î‡∏±‡∏ö 1Adv.': { rank1: 90, rank5: 65 },
        '‡∏£‡∏∞‡∏î‡∏±‡∏ö 2': { rank1: 97, rank5: 78 }, '‡∏£‡∏∞‡∏î‡∏±‡∏ö 3': { rank1: 115, rank5: 80 },
        '‡∏£‡∏∞‡∏î‡∏±‡∏ö 4': { rank1: 148, rank5: 139 }, '‡∏£‡∏∞‡∏î‡∏±‡∏ö 5': { rank1: 128, rank5: 114 },
        '‡∏£‡∏∞‡∏î‡∏±‡∏ö 6': { rank1: 113, rank5: 64 }, '‡∏£‡∏∞‡∏î‡∏±‡∏ö Open': { rank1: 54, rank5: 43 },
        '‡∏£‡∏∞‡∏î‡∏±‡∏ö Std.': { rank1: 90, rank5: 65 }
    };

    const STUDENTS = [
        { name: "‡∏î.‡∏ç.‡∏à‡∏£‡∏£‡∏¢‡∏°‡∏ì‡∏ë‡∏ô‡πå ‡∏™‡∏∏‡∏£‡∏∞‡∏ñ‡∏¥‡∏ï‡∏¢‡πå", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 1Adv." },
        { name: "‡∏î.‡∏ä.‡∏†‡∏±‡∏ó‡∏£‡∏ö‡∏î‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡πÄ‡∏´‡∏°‡∏ô‡∏¥‡∏•", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 2" },
        { name: "‡∏î.‡∏ç.‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏û‡∏π‡∏ô ‡∏ß‡∏µ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∏‡∏©", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 2" },
        { name: "‡∏î.‡∏ä.‡∏≠‡∏†‡∏¥‡∏ß‡∏∏‡∏í‡∏¥ ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏µ", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 3" },
        { name: "‡∏î.‡∏ç.‡∏ß‡∏£‡∏Å‡∏±‡∏ç‡∏ç‡∏≤ ‡∏ä‡∏≥‡∏ô‡∏¥‡∏¢‡∏±‡∏ô‡∏ï‡πå", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 5" },
        { name: "‡∏î.‡∏ç.‡∏ß‡∏£‡∏£‡∏ì‡∏ß‡∏¥‡∏™‡∏≤ ‡πÇ‡∏Ñ‡∏ï‡∏£‡∏ä‡∏∏‡∏°", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 6" },
        { name: "‡∏î.‡∏ç.‡∏ô‡∏ß‡∏•‡∏Å‡∏ô‡∏Å ‡∏™‡∏≤‡∏£‡∏µ‡∏ß‡∏á‡∏©‡πå", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 6" },
        { name: "‡∏î.‡∏ç.‡∏≠‡∏£‡∏¥‡∏¢‡πå‡∏Å‡∏±‡∏ô‡∏ï‡∏≤ ‡∏â‡∏±‡∏ï‡∏£‡∏û‡∏£‡∏ò‡∏ô‡πÇ‡∏ä‡∏ï‡∏¥", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 1Std." },
        { name: "‡∏î.‡∏ç.‡∏Å‡∏§‡∏©‡∏ß‡∏£‡∏£‡∏ì ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡πÄ‡∏£‡∏∑‡∏≠‡∏á", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö Std." },
        { name: "‡∏î.‡∏ç.‡∏õ‡∏ß‡∏£‡∏¥‡∏®‡∏©‡∏≤ ‡∏´‡∏ô‡∏π‡∏ó‡∏±‡∏ö", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö Std." },
        { name: "‡∏î.‡∏ä.‡∏ô‡∏¥‡∏ï‡∏¥‡∏ò‡∏£ ‡∏î‡∏≤‡∏ö‡∏∏‡∏ï‡∏£", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö Std." },
        { name: "‡∏î.‡∏ç.‡∏†‡∏±‡∏ó‡∏£‡∏≤‡∏û‡∏£ ‡πÇ‡∏Ñ‡∏ï‡∏£‡∏ä‡∏∏‡∏°", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 1Adv." },
        { name: "‡∏î.‡∏ä.‡∏£‡∏±‡∏ä‡∏ï‡∏∞ ‡πÇ‡∏Ñ‡∏ï‡∏£‡πÅ‡∏™‡∏ô‡∏•‡∏µ", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 3" },
        { name: "‡∏î.‡∏ä.‡∏à‡∏¥‡∏£‡∏±‡∏™‡∏ô‡∏ì‡∏†‡∏±‡∏ó‡∏£ ‡∏ï‡∏≠‡∏á‡πÅ‡∏ï‡∏°", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 4" },
        { name: "‡∏î.‡∏ç.‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏î‡∏≤ ‡∏Ñ‡∏•‡∏±‡∏á‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö 6" },
        { name: "‡∏î.‡∏ä.‡∏™‡∏¥‡∏£‡∏ß‡∏¥‡∏ä‡∏ç‡πå ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏ü‡∏±‡∏Å", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö Open" },
        { name: "‡∏î.‡∏ä.‡∏à‡∏±‡∏Å‡∏£‡∏†‡∏±‡∏ó‡∏£‡πå ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡πâ‡∏°", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö Open" },
        { name: "‡∏î.‡∏ç.‡∏°‡∏µ‡∏£‡∏¥‡∏ô‡∏î‡∏≤ ‡∏≠‡∏ô‡∏∏‡∏Å‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö Std." },
        { name: "‡∏î.‡∏ä.‡∏ò‡∏ì‡∏±‡∏ì‡∏ì‡∏û‡∏±‡∏ä‡∏£‡πå ‡∏õ‡∏ß‡∏µ‡∏ì‡∏ß‡∏±‡∏à‡∏ô‡πå", level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö Std." }
    ];
    
    const MEDAL_CRITERIA = { gold: 71, silver: 51, bronze: 21 };

    let myChart = null;
    let currentHistory = [];
    let currentEditId = null;

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    initApp();

    function initApp() {
        document.getElementById('practiceDate').valueAsDate = new Date();
        const select = document.getElementById('studentSelect');
        select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
        
        STUDENTS.sort((a, b) => a.name.localeCompare(b.name));
        STUDENTS.forEach(s => {
            let opt = document.createElement("option");
            opt.value = s.name; opt.text = s.name;
            opt.setAttribute('data-level', s.level);
            select.appendChild(opt);
        });

        select.addEventListener('change', loadStudentDataFromCloud);
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function loadStudentDataFromCloud() {
        const select = document.getElementById('studentSelect');
        const name = select.value;
        const level = select.options[select.selectedIndex]?.getAttribute('data-level');

        if (!name) {
            document.getElementById('currentLevel').innerText = "-";
            document.getElementById('maxScoreDisplay').innerText = "-";
            currentHistory = [];
            updateChartAndTable();
            return;
        }

        const maxScore = EXAM_CONFIG[level] || 100;
        document.getElementById('currentLevel').innerText = level;
        document.getElementById('maxScoreDisplay').innerText = maxScore;
        
        document.getElementById('loadingOverlay').style.display = 'flex';

        db.collection("scores").where("name", "==", name).get()
        .then((querySnapshot) => {
            currentHistory = [];
            querySnapshot.forEach((doc) => {
                let data = doc.data();
                data.id = doc.id;
                currentHistory.push(data);
            });
            updateChartAndTable();
            document.getElementById('loadingOverlay').style.display = 'none';
        })
        .catch((error) => {
            console.error("Error:", error);
            alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
            document.getElementById('loadingOverlay').style.display = 'none';
        });
    }

    function saveAllScoresToCloud() {
        const select = document.getElementById('studentSelect');
        const name = select.value;
        const level = select.options[select.selectedIndex]?.getAttribute('data-level');
        const rawDate = document.getElementById('practiceDate').value; 
        const dateStr = new Date(rawDate).toLocaleDateString('th-TH');

        if (!name || !rawDate) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
        const maxScore = EXAM_CONFIG[level] || 100;
        let batch = db.batch();
        let countSaved = 0;
        
        const inputs = document.querySelectorAll('.score-input');
        
        for(let input of inputs) {
            let val = parseFloat(input.value);
            if (!isNaN(val) && val > maxScore) {
                alert(`‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ï‡πá‡∏° (${maxScore})`); return;
            }
        }

        document.getElementById('loadingOverlay').style.display = 'flex';

        inputs.forEach((input) => {
            let val = parseFloat(input.value);
            if (!isNaN(val)) {
                let ref = db.collection("scores").doc();
                batch.set(ref, {
                    name: name, level: level, score: val, maxScore: maxScore,
                    displayDate: dateStr, rawDate: rawDate, timestamp: Date.now()
                });
                countSaved++;
                input.value = "";
            }
        });

        if (countSaved > 0) {
            batch.commit().then(() => {
                alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${countSaved} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                loadStudentDataFromCloud();
            }).catch((e) => {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        } else {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á");
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    function saveEditToCloud() {
        if(!currentEditId) return;
        let newScore = parseFloat(document.getElementById('editScoreInput').value);
        let newDate = document.getElementById('editDateInput').value;
        
        let item = currentHistory.find(d => d.id === currentEditId);
        if(item && !isNaN(newScore) && newDate) {
            if(newScore > item.maxScore) { alert("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ï‡πá‡∏°"); return; }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            db.collection("scores").doc(currentEditId).update({
                score: newScore,
                rawDate: newDate,
                displayDate: new Date(newDate).toLocaleDateString('th-TH')
            }).then(() => {
                document.getElementById('editModal').style.display = 'none';
                loadStudentDataFromCloud();
            }).catch((e) => {
                alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }
    }

    window.openEditModal = function(id) {
        let item = currentHistory.find(d => d.id === id);
        if(item) {
            currentEditId = id;
            document.getElementById('editDateInput').value = item.rawDate;
            document.getElementById('editScoreInput').value = item.score;
            document.getElementById('editModal').style.display = 'flex';
        }
    }

    window.deleteItem = function(id) {
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            db.collection("scores").doc(id).delete().then(() => {
                loadStudentDataFromCloud();
            }).catch((e) => {
                alert("‡∏•‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }
    }

    // =======================================================
    // üé® CHART PLUGINS
    // =======================================================
    
    // Plugin 1: ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Target Lines)
    const targetLinesPlugin = {
        id: 'targetLines',
        beforeDraw: (chart) => {
            const { ctx, chartArea: { left, right }, scales: { y } } = chart;
            const targets = chart.config.options.plugins.targets;
            if (targets) {
                const y1 = y.getPixelForValue(targets.rank1);
                const y5 = y.getPixelForValue(targets.rank5);
                
                // ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏à‡∏≤‡∏á‡πÜ
                ctx.save();
                ctx.fillStyle = 'rgba(46, 204, 113, 0.1)'; 
                ctx.fillRect(left, y1, right - left, y5 - y1);
                
                // ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏µ‡∏™‡πâ‡∏° (‡∏ó‡∏µ‡πà 1)
                ctx.beginPath(); ctx.lineWidth = 1; ctx.strokeStyle = '#d35400'; ctx.setLineDash([5, 5]);
                ctx.moveTo(left, y1); ctx.lineTo(right, y1); ctx.stroke();
                
                // ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏ó‡∏µ‡πà 5)
                ctx.beginPath(); ctx.lineWidth = 1; ctx.strokeStyle = '#27ae60'; ctx.setLineDash([]);
                ctx.moveTo(left, y5); ctx.lineTo(right, y5); ctx.stroke();

                // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≥‡∏Å‡∏±‡∏ö (‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)
                if (chart.width > 300) {
                    ctx.fillStyle = '#d35400'; ctx.textAlign = 'left'; ctx.font = 'bold 10px Sarabun';
                    ctx.fillText(`üèÜ ‡∏ó‡∏µ‡πà 1: ${targets.rank1} (‡∏õ‡∏µ68)`, left + 5, y1 - 5);
                    
                    ctx.fillStyle = '#27ae60';
                    ctx.fillText(`üéØ ‡∏ó‡∏µ‡πà 5: ${targets.rank5} (‡∏õ‡∏µ68)`, left + 5, y5 + 12);
                }
                ctx.restore();
            }
        }
    };

    // Plugin 2: ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Background Zones & Labels)
    const backgroundZonesPlugin = {
        id: 'backgroundZones',
        beforeDraw: (chart) => {
            const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
            const maxScore = chart.config.options.plugins.customMaxScore || 100;
            
            const yGold = y.getPixelForValue(maxScore * 0.71);
            const ySilver = y.getPixelForValue(maxScore * 0.51);
            const yBronze = y.getPixelForValue(maxScore * 0.21);
            
            ctx.save();
            
            // 1. ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‡∏™‡∏î‡πÉ‡∏™‡∏Ç‡∏∂‡πâ‡∏ô)
            // ‡∏™‡∏µ‡∏ó‡∏≠‡∏á
            ctx.fillStyle = 'rgba(255, 215, 0, 0.15)'; 
            ctx.fillRect(left, top, right - left, yGold - top);
            
            // ‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô
            ctx.fillStyle = 'rgba(192, 192, 192, 0.15)'; 
            ctx.fillRect(left, yGold, right - left, ySilver - yGold);
            
            // ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á
            ctx.fillStyle = 'rgba(205, 127, 50, 0.15)'; 
            ctx.fillRect(left, ySilver, right - left, yBronze - ySilver);
            
            // ‡∏™‡∏µ‡∏ä‡∏°‡πÄ‡∏ä‡∏¢ (‡∏°‡πà‡∏ß‡∏á)
            ctx.fillStyle = 'rgba(155, 89, 182, 0.15)'; 
            ctx.fillRect(left, yBronze, right - left, bottom - yBronze);

            // 2. ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≥‡∏Å‡∏±‡∏ö (Labels) ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô..."
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold 12px Sarabun';
            const xPos = right - 10;
            
            ctx.fillStyle = 'rgba(212, 172, 13, 0.8)'; // ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            ctx.fillText("ü•á ‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á", xPos, (top + yGold) / 2);
            
            ctx.fillStyle = 'rgba(127, 140, 141, 0.8)'; // ‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            ctx.fillText("ü•à ‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏á‡∏¥‡∏ô", xPos, (yGold + ySilver) / 2);
            
            ctx.fillStyle = 'rgba(211, 84, 0, 0.8)'; // ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            ctx.fillText("ü•â ‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á", xPos, (ySilver + yBronze) / 2);
            
            ctx.fillStyle = 'rgba(142, 68, 173, 0.8)'; // ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            ctx.fillText("üéñÔ∏è ‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ä‡∏°‡πÄ‡∏ä‡∏¢", xPos, (yBronze + bottom) / 2);

            ctx.restore();
        }
    };

    function updateChartAndTable() {
        currentHistory.sort((a, b) => { 
            if (a.rawDate !== b.rawDate) return a.rawDate.localeCompare(b.rawDate); 
            return a.timestamp - b.timestamp; 
        });

        const select = document.getElementById('studentSelect');
        const level = select.options[select.selectedIndex]?.getAttribute('data-level') || '‡∏£‡∏∞‡∏î‡∏±‡∏ö 1Std.';
        const currentMaxScore = EXAM_CONFIG[level] || 100;
        const targets = TARGET_SCORES[level];

        // üì± ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Padding ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ PC)
        const isMobile = window.innerWidth < 600;
        const topPadding = isMobile ? 30 : 50;

        const ctx = document.getElementById('progressChart').getContext('2d');
        if(myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: currentHistory.map((d, i) => i+1),
                datasets: [{
                    label: `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`,
                    data: currentHistory.map(d => d.score),
                    borderColor: '#2980b9', borderWidth: 2, 
                    pointRadius: 4, pointBackgroundColor: '#fff', pointBorderColor: '#2980b9',
                    tension: 0.3, fill: false
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                layout: { padding: { top: topPadding, right: 10, left: 0, bottom: 0 } },
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        max: currentMaxScore * 1.15, // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
                        grid: { borderDash: [2, 2] }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        callbacks: { 
                            title: (ctx) => `‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${ctx[0].label} (${currentHistory[ctx[0].dataIndex].displayDate})`, 
                            label: (ctx) => `‡∏ó‡∏≥‡πÑ‡∏î‡πâ: ${ctx.raw} / ${currentMaxScore} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô` 
                        } 
                    },
                    customMaxScore: currentMaxScore, targets: targets 
                }
            },
            plugins: [backgroundZonesPlugin, targetLinesPlugin]
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = "";
        [...currentHistory].reverse().slice(0, 30).forEach(item => {
            const percent = (item.score / item.maxScore) * 100;
            let medal = "üéñÔ∏è ‡∏ä‡∏°‡πÄ‡∏ä‡∏¢", color = "#8e44ad";
            if(percent >= MEDAL_CRITERIA.gold) { medal = "ü•á ‡∏ó‡∏≠‡∏á"; color = "#f1c40f"; }
            else if(percent >= MEDAL_CRITERIA.silver) { medal = "ü•à ‡πÄ‡∏á‡∏¥‡∏ô"; color = "#95a5a6"; }
            else if(percent >= MEDAL_CRITERIA.bronze) { medal = "ü•â ‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á"; color = "#d35400"; }
            tbody.innerHTML += `<tr>
                <td>${item.displayDate}</td>
                <td style="font-weight:bold;font-size:16px;">${item.score}</td>
                <td style="color:${color};font-weight:bold;">${medal}</td>
                <td>
                    <button class="action-btn edit-btn" onclick="openEditModal('${item.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="action-btn del-btn" onclick="deleteItem('${item.id}')">‡∏•‡∏ö</button>
                </td>
            </tr>`;
        });
    }
</script>

</body>
</html>
